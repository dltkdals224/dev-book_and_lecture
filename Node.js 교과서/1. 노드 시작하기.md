# 1장. 노드 시작하기

## 1.1 핵심 개념 이해하기

[노드 공식 사이트](https://nodejs.org/ko/)에서 노드에 대해 다음과 같이 설명하고 있다.<br/>
Node.js는 Chrome V8 Javasciprt 엔진으로 빌드된 자바스크립트 런타임이다.

노드가 서버라는 말이 없는 이유는, 노드가 서버만 실행할 수 있는 것은 아니기 때문.

<br/>

### 1.1.1 서버

서버는 네트워크를 통해 클라이언트에 정보나 서비스를 제공하는 컴퓨터 또는 프로그램을 말한다.

<br/>

### 1.1.2 자바스크립트 런타임

`노드`는 `자바스크립트 런타임`이다.<br/>
`런타임`은 `특정 언어로 만든 프로그램들을 실행할 수 있는 환경`을 뜻한다.<br/>
따라서 노드는 자바스크립트 프로그램을 로컬 컴퓨터에서 실행할 수 있다.

노드는 오픈 소스 자바스크립트 엔진 `V8`과 논블로킹 I/O모델 구현을 위한 `libuv`라는 라이브러리를 사용한다.

<br/>

### 1.1.3 이벤트 기반

이벤트 기반(dvent-driven)이란 이벤트가 발생할 때 미리 지정해둔 작업을 수행하는 방식을 의미한다.<br/>
대표적으로 클릭이나 네트워크 요청 등이 있다.

이벤트 기반 시스템에서는 특정 이벤트가 발생할 때, 무엇을 할지 미리 등록해둬야 한다.<br/>
이를 이벤트 리스너(event listener)에 콜백(callback) 함수를 등록한다고 표현한다.

이벤트 기반 모델에서는 `이벤트 루프(event loop)`라는 개념이 등장한다.<br/>
여러 이벤트가 동시에 발생할 경우, 어떤 순서로 콜백 함수를 호출할지를 이벤트 루프가 판단한다.

![](https://images.velog.io/images/leejihun96/post/f3c45d7d-0bc4-4b9e-b957-6333aca86cdc/image.png)

- `이벤트 루프`: 이벤트 발생 시 호출할 콜백 함수들을 관리하고, 호출된 콜백 함수의 실행순서를 결정. <br/>
  노드가 종료될 때까지 이벤트 처리를 위한 작업을 반복한다.<br/>
- `백그라운드`: 타이머나 이벤트 리스터들이 대기하는 공간. 여러 작업이 동시에 실행될 수 있음.<br/>
- `태스크 큐`: 이벤트 발생 후, 백그라운드에서는 태스크 큐로 타이머나 이벤트 리스터의 콜백 함수를 보냄.<br/>
  보통 완료된 순서로 줄을 서있지만, 특정한 경우 순서사 바뀌기도 함.

1. 먼저 전역 콘텍스트인 anonymous(여기서는 main())이 호출 스택에 삽입된다.<br/>
2. 그 이후 setTimeout이 호출 스택에 들어간다.<br/>
3. 호출 스택에 들어간 순서와 반대로 실행되므로, setTimeout이 먼저 실행된다.<br/>
4. 타이머와 함께 run 콜백을 백그라운드로 보내고, setTimeout이 호출 스택에서 제거된다.<br/>
5. 그 이후 anonymous가 호출 스택에서 제거된다.<br/>
6. 백그라운드에서는 5초가 지난 후 run함수를 태스크 큐로 보낸다.<br/>
7. 이벤트 루프는 호출 스택이 비어있을 경우에만 태스크 큐의 작업을 가져와 실행하기 때문에, <br/>
   호출 스택에 함수가 너무 많다면 5초가 지난 후에도 run 함수가 실행되지 않을 수도 있다.<br/>
   이것이 setTimeout의 시간이 정확하지 않을 수도 있는 이유이다.

<br/>

### 1.1.4 논블로킹 I/O

작업에는 두가지 종류가 있다. 동시에 실행될 수 있는 작업과 동시에 실행될 수 없는 작업.<br/>
기본적으로 개발자가 작성한 자바스크립트 코드는 동시에 실행될 수 없다.<br/>
하지만, I/O 작업 같은 것들은 동시에 처리될 수 있다.

I/O는 Input과 Output을 말한다.<br/>
파일 시스템 접근이나 네트워크를 통한 요청 같은 작업들을 일컫는다.

이러한 작업을 진행하는데 노드는 `논블로킹` 방식으로 처리하는 방법을 제공한다.<br/>
`논블로킹`이란 `이전 작업이 완료될 때까지 대기하지 않고 다음 작업을 수행하는 것`을 의미한다.

setImmediate()같은 함수는 노드에서 코드를 논블로킹으로 만들기위해 사용하는 기법 중 하나이다.<br/>
다만, 아무리 논블로킹 방식으로 코드를 짜더라도, 내가 작성한 코드라면(I/O 작업과 관련한 것이 아니라면) 전체 소요시간이 짧아지지는 않는다.<br/>
하지만 I/O 작업이 없다고 해서 논블로킹이 의미가 없지는 않다.<br/>
실행 순서를 바꿈으로써 간단한 작업들이 대기하는 것을 막을 수 있다.

`동기`와 `블로킹`이 유사하고, `비동기`와 `논블로킹`이 유사하다. 하지만 이는 같은 개념은 아니다.<br/>
자세한 차이에 대해서는 후술한다.

<br/>

### 1.1.5 싱글 스레드

내가 작성한 자바스크립트 코드가 동시에 실행될 수 없는 궁극적 원인.

우선 프로세스와 스레드의 차이에 대해서 알아보자.<br/>

- `프로세스`: 운영체제에서 할당하는 작업의 단위. 프로세스 간에 메모리등의 자원을 공유하지 않는다.<br/>
- `스레드`: 프로세스 내에서 실행되는 흐름의 단위. 스레드들은 부모 프로세스의 자원을 공유한다.

노드는 사실 엄밀히 말하면 싱글 스레드가 아니다.<br/>
노드를 실행하면 프로세스가 하나 생성되고, 내부적으로 스레드를 여러개 생성한다.<br/>
다만 그것들 중 내가 제어할 수 있는 스레드는 하나뿐인 것.

블로킹이 심하게 일어나는 작업을 처리하지만 않는다면 스레드 하나로도 충분하다.<br/>
블로킹이 발생하는 경우는 논블로킹을 사용해 대기시간을 최소화한다.

노드가 싱글 스레드로 동작하지 않는 두가지 경우.<br/>

1. 스레드 풀: 노드가 특정 동작을 수행할 때, 스스로 멀티 스레드를 사용한다. 대표적으로 암호화, 파일 입출력, 압축 등이 있다.<br/>
2. 워커 스레드: 개발자가 직접 다수의 스레드를 다루기 위해 사용할 때 사용하는 스레드.

멀티 스레드가 싱글 스레드보다 좋아 보이지만 반드시 그런것도 아니다.

노드가 채택하고 있는 방식은 `싱글 스레드, 논블로킹 모델`이다.

| `멀티 스레딩`                                | `멀티 프로세싱`         |
| -------------------------------------------- | ----------------------- |
| 하나의 프로세스 안에서 여러 개의 스레드 사용 | 여러 개의 프로세스 사용 |
| CPU 작업이 많이 사용될 때 사용               | I/O 요청이 많을 때 사용 |
| 프로그래밍이 어려움                          | 비교적 쉬움             |

<br/>

## 1.2 서버로서의 노드

노드 서버의 장단점은 싱글 스레드, 논블로킹 모델의 장단점과 다르지 않다.

노드는 CPU 부하가 큰 작업에는 적합하지 않다.<br/>
단일 스레드에서 모든 코드를 감당하는데 부담이 있기 때문이다.<br/>

노드 12 버전에서 워커 스레드 기능의 안정화로 멀티 스레드 작업을 할 수 있게 되었지만,<br/>
멀티스레드 프로그래밍을 하는 것은 난이도가 굉장히 높다.<br/>
멀티 스레딩 기능이 있다고 하더라도 이미지나 비디오 처리, 대규모 데이터 처리와 같이<br/>
CPU를 많이 사용하는 작업을 위한 서버로는 권장되지 않는다.

노드는 개수는 많지만 크기는 작은 데이터를 실시간으로 주고받는 애플리케이션의 서버로 적합하다.<br/>
네트워크나 데이터베이스, 디스크 작업 같은 I/O에 특화되어 있기 때문이다.

노드의 가장 큰 장점은 자바스크립트를 언어로 사용한다는 것이다.

| 장점                                          | 단점                                              |
| --------------------------------------------- | ------------------------------------------------- |
| 멀티 스레드 방식에 비해 적은 컴퓨터 자원 사용 | 기본적으로 싱글 스레드라서 CPU 코어를 하나만 사용 |
| I/O 작업이 많은 서버로 적합                   | CPU 작업이 많은 서버로는 부적합                   |
| 멀티 스레드 방식보다 쉬움                     | 하나뿐인 스레드가 멈추지 않도록 관리 필요         |
| 웹 서버가 내장되어 있음                       | 서버 규모가 커졌을 때 서버를 관리하기 어려움      |
| 자바스크립트(+json)를 사용                    | 어중간한 성능                                     |

<br/>

## 1.3 서버 외의 노드

노드는 자바스크립트 런타임이므로 용도가 서버로만 국한되지 않는다.<br/>
노드 기반으로 작동되는 대표적인 웹 프레임워크로는 앵귤러(Angular), 리액트(React), 뷰(Vue) 등이 있다.

<br/>

## 1.4 개발 환경 설정하기

(생략)

<br/>

## 1.5 함께 보면 좋은 자료

[노드 공식 사이트의 가이드](https://nodejs.org/ko/docs/guides/)

[노드에 대한 전반적인 설명](https://nodejs.dev/en/learn/)

[이벤트 루프 설명](https://nodejs.org/ko/docs/guides/event-loop-timers-and-nexttick/)

[이벤트 루프 시작적 설명](http://latentflip.com/loupe)

<br/>
